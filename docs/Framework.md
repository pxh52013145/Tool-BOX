# Toolbox（Qt）总体方案（Windows 优先）

## 1. 目标与范围

### 1.1 产品定位
- 常驻系统托盘的“工具箱”应用，采用“核心框架 + 功能模块（Feature）+ 平台适配（Platform）”的方式逐步扩展。
- 首批落地两个模块：
  - 密码管理器：统一管理网站/应用账号；对网页支持“检测登录框→弹出账号选择→一键填充”；对表单提交支持“新增/更新密码”提示。
  - 翻译工具：系统级划词/选区翻译；支持悬浮球（小球）与就近弹窗；跨软件可用（不局限浏览器）。

### 1.2 明确非目标（MVP 阶段）
- 不做“无授权读取/解密浏览器本地密码库”的方案（风险高、兼容差、易触发安全软件）。
- 不追求对所有第三方应用 100% 自动识别/填充（以浏览器网页与主流控件体系为主，逐步补齐）。

## 2. MVP 里程碑（建议）
- M0：托盘常驻 + 设置页（热键、语言、翻译引擎、账户安全）+ 日志与诊断开关。
- M1（翻译先行）：全局热键触发（例如 `Ctrl+Shift+T`）→读取当前选中文本（UIA/剪贴板兜底）→弹出翻译浮窗。
- M2：悬浮球模式（小球常驻/自动隐藏）→悬停/点击弹出翻译；支持固定/跟随光标。
- M3（密码管理最小闭环）：本地加密 Vault + 登录条目 CRUD + 从浏览器“官方导出 CSV”导入。
- M4（网页填充）：Chrome/Edge/Firefox 扩展 + Native Messaging 与桌面端通信 → 在检测到登录表单时显示账号列表并填充。
- M5（保存/更新提示）：扩展监听表单提交/密码字段变化 → 桌面端弹窗确认保存/更新并写入 Vault。

## 3. 总体架构

### 3.1 分层
- `App(UI)`：Qt 窗口、托盘、设置、模块入口、弹窗与悬浮球。
- `Core`：配置、日志、事件总线、加密与 Vault、模型与存储、权限/解锁状态机。
- `Features`
  - `feature_password`：Vault、导入导出、匹配策略、浏览器对接协议。
  - `feature_translate`：取词、翻译请求、缓存、展示与交互。
- `Platform (Windows)`：全局热键、鼠标/键盘钩子（可选）、UI Automation 取词/填充、窗口定位、置顶/不抢焦点浮窗。

### 3.2 进程与通信
建议单进程起步，预留扩展通信：
- 浏览器扩展（必需）：使用 Native Messaging Host 启动/连接桌面端。
- 本地 IPC（可选增强）：`QLocalServer`（命名管道）或本地 WebSocket/HTTP（仅 `127.0.0.1`），用于：
  - 扩展→桌面端：查询可用账号、请求填充、保存/更新提示
  - 桌面端→扩展：主动锁定/解锁状态、配置更新

## 4. 密码管理器（Password）

### 4.1 为什么“扩展 + 桌面端”是主路径
网页中的账号/密码输入框在浏览器渲染进程内（DOM），系统级 UIA 很难稳定拿到字段语义，更难可靠填充/监听提交。  
因此对“网页”建议：
- 浏览器扩展负责：检测表单、定位字段、执行填充、捕获提交事件。
- 桌面端负责：Vault、匹配与策略、UI 弹窗、审计日志与同步扩展状态。

### 4.2 数据模型（最小）
- `Vault`：加密容器；包含多个 `LoginItem`
- `LoginItem`：
  - `id`
  - `origin`（协议+域名/或匹配规则集合）
  - `username`
  - `password`（仅在解锁状态可解密）
  - `notes`、`tags`
  - `updatedAt`、`createdAt`
  - 可选：`totpSecret`、`customFields`、`passwordHistory`

### 4.3 站点匹配策略（建议从简单到复杂）
- Level 1：按 `eTLD+1`（示例：`accounts.google.com` 与 `mail.google.com` 归为 `google.com`）匹配。
- Level 2：支持 `origin` 精确匹配与允许列表（`https://a.example.com`）。
- Level 3：支持规则（wildcard/regex）与 Android App package、Windows AppId（后续）。

### 4.4 Vault 与安全（建议）
核心原则：即使应用被拷贝文件，也无法离线解密。
- Master Password + KDF（`Argon2id`）派生主密钥。
- 内容加密：推荐 `XChaCha20-Poly1305`（随机 nonce）或 `AES-256-GCM`（如依赖 OpenSSL/QCA）。
- 本机绑定（可选增强）：Windows DPAPI 再包一层“设备密钥”，用于“免密解锁”或提升离线攻击成本。
- 自动锁定：超时、睡眠、切换用户、屏幕锁定事件触发。
- 剪贴板安全：复制密码后定时清空；可选“仅一次粘贴”。

### 4.5 与浏览器对接（推荐方案）
- 导入：优先支持浏览器“官方导出 CSV”导入（Chrome/Edge/Firefox 都支持），作为无扩展情况下的基础路径。
- 扩展对接：
  - 扩展检测到登录表单 → 发送 `{origin, pageTitle, formMeta}` 到桌面端
  - 桌面端返回候选账号列表（不返回明文密码，直到用户确认/策略允许）
  - 用户选择账号 → 桌面端签发一次性填充令牌（短时有效）→ 扩展用令牌请求解密并填充
  - 表单提交时扩展回传 `{origin, username, passwordCandidate, isUpdate}` → 桌面端弹窗确认保存/更新

### 4.6 原生应用填充（可选，后置）
- 优先覆盖：标准 Win32/WinUI/WPF 输入控件（UIA `ValuePattern` 可写）。
- 降级策略：仅提供“账号一键复制/密码一键复制”而不做自动写入控件。

## 5. 翻译工具（Translator）

### 5.1 系统级“取词”策略（Windows）
从稳定性角度建议分层兜底：
1) UI Automation 读取“选中文本”（优先）：对支持 `TextPattern`/`TextPattern2` 的控件可直接取到 Selection。
2) 剪贴板兜底：触发用户配置的复制快捷键（默认 `Ctrl+C`，需谨慎，避免破坏用户剪贴板；建议读取后还原剪贴板内容）。
3) OCR（后续）：截图选区 + OCR 取词（PowerToys Text Extractor 类似体验）。

### 5.2 展示形态
- 就近浮窗：鼠标附近/文本选区附近出现，支持固定、自动消失、Pin。
- 悬浮球：小球常驻，悬停/点击弹出；可自动贴边、透明度渐变。
- 不抢焦点：Windows 需要无激活窗口（`WS_EX_NOACTIVATE`）以避免影响输入（Qt 需平台层处理）。

### 5.3 翻译引擎抽象
- `TranslateProvider` 接口（插件化）：输入文本+源/目标语言+上下文 → 输出译文+检测语言+可选词典信息
- 支持多提供方：公开 API（需要用户配置 key）、本地模型（可选）、自建服务（可选）
- 结果缓存：同文本+语言对缓存（LRU + TTL），减少费用与延迟
- 流式输出（可选）：对 LLM/流式接口可边到边展示

## 6. 代码组织建议（qmake 起步，可平滑迁移 CMake）
建议目录（不强制，先在 docs 对齐）：
- `src/app`：入口、托盘、路由
- `src/core`：配置、日志、加密、IPC、模型
- `src/platform/windows`：UIA、hotkey、window utils
- `src/features/password`
- `src/features/translate`
- `extensions/`：浏览器扩展（后续加入）

## 7. 风险与对策（必须提前认清）
- 兼容性：系统级取词/浮窗涉及大量边角（管理员权限、UAC、全屏游戏、IDE/控制台）；必须有降级路径。
- 安全合规：任何“读取浏览器本地加密库”的做法都要非常谨慎；建议以“用户导入/扩展授权”作为标准路径。
- 体验：弹窗/悬浮球若抢焦点或遮挡会被弃用；需要大量可配置项（延迟、位置、透明度、黑名单应用）。

## 8. 下一步（落地顺序建议）
1) 先做翻译 M1/M2：更容易跑通“系统级能力 + 浮窗交互 + 配置体系”。
2) 再做密码 M3：Vault + CRUD + 导入（无扩展也可用）。
3) 最后做密码 M4/M5：扩展对接与保存/更新提示（工程量最大，但体验提升最显著）。

细化方案见：`docs/PasswordManage.md` 与 `docs/Translator.md`。

## 9. 参考与对标（建议先看这些实现思路）
- 密码管理器：KeePassXC（Qt）、Bitwarden（桌面端+浏览器扩展）、Browserpass（扩展桥接本地服务）
- 系统级取词/OCR：Microsoft PowerToys（Text Extractor）、ShareX（截图与工作流）
- 悬浮窗/工具面板：PowerToys Run（交互与插件化思路）

## 10. Backlog（可直接按此拆分迭代）
- M0：托盘与设置：托盘菜单、开机启动、热键配置、provider 配置、日志开关
- M1：取词与浮窗：Windows UIA 取词、剪贴板兜底、翻译请求队列/取消、浮窗定位与不抢焦点
- M2：悬浮球：拖拽/贴边/透明度、黑名单应用、跟随鼠标/选区定位
- M3：Vault：解锁/锁定状态机、加密读写、条目 CRUD、导入 CSV、搜索与标签
- M4：扩展：Native Messaging host、扩展表单检测与填充 UI、与桌面端的配对与鉴权
- M5：保存/更新：扩展提交检测、桌面端确认弹窗、重复/冲突处理、密码历史
